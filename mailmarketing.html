<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Mail Marketing Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1400px;
            min-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab.active {
            background: #4a90e2;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #e8f4f8;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #34495e;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e6ed;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .btn {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #357abd;
        }

        .btn.success {
            background: #27ae60;
        }

        .btn.danger {
            background: #e74c3c;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            min-height: 500px;
        }

        .editor {
            min-height: 400px;
            max-height: 500px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
        }

        .preview {
            border: 2px solid #e0e6ed;
            border-radius: 6px;
            padding: 20px;
            background: white;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
        }

        .recipient-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e0e6ed;
            border-radius: 6px;
            padding: 15px;
        }

        .recipient {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .recipient:last-child {
            border-bottom: none;
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.pending {
            background: #f39c12;
            color: white;
        }

        .status.sent {
            background: #27ae60;
            color: white;
        }

        .status.error {
            background: #e74c3c;
            color: white;
        }

        .status.sending {
            background: #3498db;
            color: white;
        }

        .progress {
            background: #ecf0f1;
            border-radius: 10px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: #4a90e2;
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            border-radius: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .file-input {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .file-input input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 6px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .file-input:hover .file-input-label {
            background: #e9ecef;
            border-color: #4a90e2;
        }

        .section h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }

        #templateFields {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
        }

        #templateFields .form-group {
            margin-bottom: 15px;
        }

        #templateFields label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }

        #templateFields input,
        #templateFields textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.15s ease-in-out;
        }

        #templateFields input:focus,
        #templateFields textarea:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.25);
        }

        #templateFields textarea {
            resize: vertical;
            line-height: 1.4;
        }

        .tab[type="button"] {
            border: 2px solid #e0e6ed;
            background: white;
        }

        .tab[type="button"].active {
            border-color: #4a90e2;
        }

        @media (max-width: 1250px) {
            .container {
                min-width: auto;
                max-width: 100%;
                padding: 15px;
            }
            
            .grid {
                grid-template-columns: 1fr;
                min-height: auto;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .form-group div[style*="grid-template-columns: 2fr 1fr 1fr 1fr"] {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .section div[style*="grid-template-columns: 1fr 1fr"] {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìß E-Mail Marketing Tool</h1>
            <p>Einfaches Tool f√ºr personalisierte E-Mail-Kampagnen</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('template')">üìù Template</button>
            <button class="tab" onclick="showTab('recipients')">üë• Empf√§nger</button>
            <button class="tab" onclick="showTab('send')">üöÄ Versenden</button>
            <button class="tab" onclick="showTab('config')">‚öôÔ∏è Konfiguration</button>
        </div>

        <!-- Konfiguration Tab -->
        <div id="config" class="tab-content">
            <div class="section">
                <h3>EmailJS Konfiguration</h3>
                <div class="alert" style="background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb;">
                    <strong>üìã Setup-Anleitung:</strong><br>
                    1. Account auf <a href="https://emailjs.com" target="_blank" style="color: #1565c0;">emailjs.com</a> erstellen<br>
                    2. Email Service (Gmail/Outlook) verbinden<br>
                    3. Template erstellen mit Variablen: {{to_name}}, {{from_name}}, {{subject}}, {{message}}<br>
                    4. IDs hier eintragen
                </div>
                
                <div class="form-group">
                    <label for="serviceId">Service ID:</label>
                    <input type="text" id="serviceId" placeholder="service_xxxxxxx">
                    <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                        Findest du unter "Email Services" in deinem EmailJS Dashboard
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="templateId">Template ID:</label>
                    <input type="text" id="templateId" placeholder="template_xxxxxxx">
                    <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                        Findest du unter "Email Templates" in deinem EmailJS Dashboard
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="userId">Public Key (User ID):</label>
                    <input type="text" id="userId" placeholder="E7m0JpVn9GC6WNcvF">
                    <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                        Das ist der "Public Key" unter "Account" > "General" in deinem EmailJS Dashboard
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="fromName">Dein Name:</label>
                    <input type="text" id="fromName" placeholder="Anna M√ºller">
                </div>
                
                <button class="btn" onclick="saveConfig()">Konfiguration speichern</button>
                <div id="configStatus"></div>
            </div>

            <div class="section">
                <h3>Konfiguration & Templates sichern</h3>
                <div class="alert" style="background: #e8f5e8; color: #2d5a2d; border: 1px solid #a3d9a3;">
                    <strong>üí° Tipp:</strong> Sichere deine Einstellungen und Templates um sie auf anderen Browsern oder Computern zu verwenden!
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div>
                        <h4 style="margin-bottom: 10px; color: #2c3e50;">üì§ Exportieren</h4>
                        <button class="btn" onclick="exportConfig()" style="width: 100%;">
                            üíæ Alle Daten herunterladen
                        </button>
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                            L√§dt eine .json Datei mit allen Einstellungen und Templates herunter
                        </small>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 10px; color: #2c3e50;">üì• Importieren</h4>
                        <div class="file-input">
                            <input type="file" id="configFile" accept=".json" onchange="importConfig()">
                            <div class="file-input-label" style="width: 100%; text-align: center;">
                                üìÅ .json Datei ausw√§hlen
                            </div>
                        </div>
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                            L√§dt gespeicherte Konfiguration und Templates
                        </small>
                    </div>
                </div>
                
                <div id="importStatus" style="margin-top: 15px;"></div>
            </div>
        </div>

        <!-- Template Tab -->
        <div id="template" class="tab-content active">
            <div class="section">
                <h3>E-Mail Template</h3>
                
                <!-- Template Management -->
                <div class="form-group">
                    <label>Template verwalten:</label>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; align-items: end;">
                        <div>
                            <select id="savedTemplates" onchange="loadSelectedTemplate()">
                                <option value="">-- Gespeicherte Templates --</option>
                            </select>
                        </div>
                        <div>
                            <input type="text" id="templateName" placeholder="Template Name">
                        </div>
                        <div>
                            <button class="btn" onclick="saveTemplate()">üíæ Speichern</button>
                        </div>
                        <div>
                            <button class="btn danger" onclick="deleteTemplate()">üóëÔ∏è L√∂schen</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="subject">Betreff:</label>
                    <input type="text" id="subject" placeholder="Hallo {{name}}, dein Lerncoaching Update!" value="Hallo {{name}}, dein pers√∂nliches Update!">
                </div>
                
                <!-- Editor Mode Tabs -->
                <div class="form-group">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button type="button" class="tab active" id="simpleEditorTab" onclick="switchEditorMode('simple')">üìù Einfacher Editor</button>
                        <button type="button" class="tab" id="htmlEditorTab" onclick="switchEditorMode('html')">üîß HTML Editor</button>
                    </div>
                </div>
                
                <div class="grid">
                    <div>
                        <!-- Simple Editor -->
                        <div id="simpleEditor">
                            <label>Template bearbeiten:</label>
                            <div id="templateFields">
                                <p style="text-align: center; color: #6c757d; margin: 20px 0;">
                                    Klicke auf "üîÑ Template analysieren" um editierbare Bereiche zu finden
                                </p>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button type="button" class="btn" onclick="parseTemplate()">üîÑ Template analysieren</button>
                                <button type="button" class="btn success" onclick="applyChanges()" id="applyBtn" style="display: none;">‚úÖ √Ñnderungen √ºbernehmen</button>
                            </div>
                        </div>
                        
                        <!-- HTML Editor -->
                        <div id="htmlEditor" style="display: none;">
                            <label for="htmlContent">HTML Template:</label>
                            <textarea id="htmlContent" class="editor" placeholder="Dein HTML Template hier..."><!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sommerkurse 2025</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f4f4f4;">
    <div style="max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px;">
        <h1 style="color: #333; border-bottom: 3px solid #4a90e2; padding-bottom: 10px;">
            Hallo {{name}}! üëã
        </h1>
        
        <h2 style="color: #4a90e2; margin-top: 25px;">
            Deine pers√∂nlichen Lernziele
        </h2>
        
        <p style="font-size: 16px; color: #555;">
            Ich hoffe, es geht dir gut und du kommst mit deinem Lernprojekt gut voran!
        </p>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="color: #4a90e2; margin-top: 0;">üìö Dein pers√∂nlicher Lerntipp:</h3>
            <p style="margin-bottom: 0;">
                Denk daran: Kleine, regelm√§√üige Lerneinheiten sind oft effektiver als lange Marathonsitzungen. 
                Plane dir heute 15 Minuten f√ºr dein Lernziel ein!
            </p>
        </div>
        
        <p style="color: #555;">
            Falls du Fragen hast oder Unterst√ºtzung brauchst, melde dich gerne bei mir.
        </p>
        
        <p style="color: #555;">
            Liebe Gr√º√üe,<br>
            <strong>Anna</strong>
        </p>
        
        <hr style="border: none; border-top: 1px solid #eee; margin: 30px 0;">
        
        <p style="font-size: 12px; color: #888; text-align: center;">
            Du erh√§ltst diese E-Mail, weil du dich f√ºr mein Lerncoaching interessiert hast.<br>
            <a href="#" style="color: #4a90e2;">Abmelden</a>
        </p>
    </div>
</body>
</html></textarea>
                        </div>
                    </div>
                    <div>
                        <label>Live Vorschau:</label>
                        <small style="color: #f39c12; display: block; margin-bottom: 5px;">
                            ‚ö†Ô∏è Die Vorschau kann leicht von der finalen E-Mail abweichen - E-Mail Clients rendern anders
                        </small>
                        <div id="preview" class="preview">
                            Vorschau wird hier angezeigt...
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="updatePreview()">Vorschau aktualisieren</button>
            </div>
        </div>

        <!-- Empf√§nger Tab -->
        <div id="recipients" class="tab-content">
            <div class="section">
                <h3>Empf√§nger Liste</h3>
                
                <!-- Manuelle Eingabe -->
                <div class="form-group">
                    <label>Empf√§nger manuell hinzuf√ºgen:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                        <div>
                            <input type="text" id="manualName" placeholder="Name (optional)">
                        </div>
                        <div>
                            <input type="email" id="manualEmail" placeholder="E-Mail">
                        </div>
                        <div>
                            <button class="btn" onclick="addManualRecipient()">‚ûï Hinzuf√ºgen</button>
                        </div>
                    </div>
                    <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                        Name ist optional - du kannst auch nur E-Mail-Adressen eingeben
                    </small>
                </div>
                
                <!-- CSV Upload -->
                <div class="form-group">
                    <label>CSV-Datei hochladen:</label>
                    <div class="file-input">
                        <input type="file" id="csvFile" accept=".csv" onchange="loadCSV()">
                        <div class="file-input-label">
                            üìÅ CSV-Datei ausw√§hlen
                        </div>
                    </div>
                    <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                        Format: <strong>Nur E-Mails:</strong> eine pro Zeile <strong>ODER</strong> <strong>Name + E-Mail:</strong> zwei Spalten
                    </small>
                </div>
                
                <!-- Aktionen -->
                <div class="form-group">
                    <button class="btn" onclick="loadTestData()">üß™ Test-Daten laden</button>
                    <button class="btn danger" onclick="clearRecipients()" style="margin-left: 10px;">üóëÔ∏è Alle l√∂schen</button>
                </div>
                
                <div id="recipientsList" class="recipient-list">
                    <p style="text-align: center; color: #7f8c8d;">Keine Empf√§nger geladen</p>
                </div>
                <div id="recipientStats"></div>
            </div>
        </div>

        <!-- Versenden Tab -->
        <div id="send" class="tab-content">
            <div class="section">
                <h3>E-Mail Kampagne versenden</h3>
                <div id="sendStatus"></div>
                
                <!-- Empf√§nger √úbersicht -->
                <div class="form-group">
                    <label>Empf√§nger √úbersicht:</label>
                    <div id="sendRecipientsList" class="recipient-list" style="max-height: 200px;">
                        <p style="text-align: center; color: #7f8c8d;">Keine Empf√§nger geladen</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Versand-Geschwindigkeit:</label>
                    <select id="sendSpeed">
                        <option value="2000">Langsam (1 E-Mail alle 2 Sekunden)</option>
                        <option value="1000" selected>Normal (1 E-Mail pro Sekunde)</option>
                        <option value="500">Schnell (2 E-Mails pro Sekunde)</option>
                    </select>
                </div>
                
                <div class="progress" id="progressContainer" style="display: none;">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div id="progressText" style="display: none; text-align: center; margin-top: 10px;"></div>
                
                <button class="btn success" id="sendBtn" onclick="startSending()">üì§ Kampagne starten</button>
                <button class="btn danger" id="stopBtn" onclick="stopSending()" style="display: none;">‚èπÔ∏è Stoppen</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        // Globale Variablen
        let recipients = [];
        let sendingActive = false;
        let sendingStats = { sent: 0, errors: 0, total: 0 };

        // Tab Navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Wenn Versenden-Tab ge√∂ffnet wird, Empf√§nger-Liste aktualisieren
            if (tabName === 'send') {
                updateSendRecipientsList();
            }
        }

        // Empf√§nger Liste f√ºr Versenden-Tab
        function updateSendRecipientsList() {
            const container = document.getElementById('sendRecipientsList');
            
            if (recipients.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Keine Empf√§nger geladen - gehe zu "Empf√§nger" Tab</p>';
                return;
            }

            container.innerHTML = recipients.map((recipient, index) => `
                <div class="recipient">
                    <div>
                        <strong>${recipient.name}</strong><br>
                        <small style="color: #7f8c8d;">${recipient.email}</small>
                    </div>
                    <span class="status ${recipient.status}" id="status-${index}">${getStatusText(recipient.status)}</span>
                </div>
            `).join('');
        }

        // Konfiguration speichern
        function saveConfig() {
            const serviceId = document.getElementById('serviceId').value;
            const templateId = document.getElementById('templateId').value;
            const userId = document.getElementById('userId').value;
            const fromName = document.getElementById('fromName').value;

            if (!serviceId || !templateId || !userId || !fromName) {
                showStatus('configStatus', 'Bitte alle Felder ausf√ºllen', 'error');
                return;
            }

            // EmailJS initialisieren
            emailjs.init(userId);

            localStorage.setItem('emailConfig', JSON.stringify({
                serviceId, templateId, userId, fromName
            }));

            showStatus('configStatus', 'Konfiguration gespeichert!', 'success');
        }

        // Konfiguration laden
        function loadConfig() {
            const config = localStorage.getItem('emailConfig');
            if (config) {
                const { serviceId, templateId, userId, fromName } = JSON.parse(config);
                document.getElementById('serviceId').value = serviceId || '';
                document.getElementById('templateId').value = templateId || '';
                document.getElementById('userId').value = userId || '';
                document.getElementById('fromName').value = fromName || '';
                
                // EmailJS initialisieren falls User ID vorhanden
                if (userId) {
                    emailjs.init(userId);
                }
            }
        }

        // CSV laden mit verbessertem Debugging
        function loadCSV() {
            const file = document.getElementById('csvFile').files[0];
            if (!file) return;

            Papa.parse(file, {
                complete: function(results) {
                    console.log('CSV Raw Data:', results.data);
                    
                    const processedRecipients = [];
                    const errors = [];
                    
                    results.data.forEach((row, rowIndex) => {
                        // Leere Zeilen √ºberspringen
                        if (!row || row.length === 0 || (row.length === 1 && !row[0].trim())) {
                            return;
                        }
                        
                        let name = '';
                        let email = '';
                        
                        if (row.length === 1) {
                            // Nur E-Mail vorhanden
                            email = row[0].trim();
                            name = getNameFromEmail(email);
                        } else if (row.length >= 2) {
                            // Name und E-Mail vorhanden
                            name = row[0].trim() || getNameFromEmail(row[1].trim());
                            email = row[1].trim();
                        }
                        
                        // E-Mail validieren
                        if (email && isValidEmail(email)) {
                            // Pr√ºfen ob E-Mail bereits existiert
                            if (!processedRecipients.some(r => r.email === email)) {
                                processedRecipients.push({
                                    id: processedRecipients.length,
                                    name: name,
                                    email: email,
                                    status: 'pending'
                                });
                            } else {
                                errors.push(`Zeile ${rowIndex + 1}: Doppelte E-Mail "${email}"`);
                            }
                        } else {
                            errors.push(`Zeile ${rowIndex + 1}: Ung√ºltige E-Mail "${email}"`);
                        }
                    });
                    
                    recipients = processedRecipients;
                    
                    console.log('Processed Recipients:', recipients);
                    console.log('Errors:', errors);
                    
                    if (errors.length > 0) {
                        const errorMsg = `CSV geladen mit ${errors.length} Fehlern:\n${errors.slice(0, 5).join('\n')}${errors.length > 5 ? '\n...' : ''}`;
                        alert(errorMsg);
                    }
                    
                    displayRecipients();
                    updateRecipientStats();
                },
                header: false,
                skipEmptyLines: true,
                delimiter: ',',
                quotes: true
            });
        }

        // Name aus E-Mail-Adresse generieren
        function getNameFromEmail(email) {
            // anna.mueller@example.com ‚Üí Anna Mueller
            // max@company.de ‚Üí Max
            const localPart = email.split('@')[0];
            const nameParts = localPart.split(/[._-]+/);
            return nameParts
                .map(part => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase())
                .join(' ');
        }

        // Manuellen Empf√§nger hinzuf√ºgen
        function addManualRecipient() {
            const name = document.getElementById('manualName').value.trim();
            const email = document.getElementById('manualEmail').value.trim();
            
            if (!email) {
                alert('Bitte E-Mail-Adresse eingeben');
                return;
            }
            
            if (!isValidEmail(email)) {
                alert('Bitte g√ºltige E-Mail-Adresse eingeben');
                return;
            }
            
            // Pr√ºfen ob E-Mail bereits existiert
            if (recipients.some(r => r.email === email)) {
                alert('E-Mail-Adresse bereits vorhanden');
                return;
            }
            
            recipients.push({
                id: recipients.length,
                name: name || getNameFromEmail(email), // Fallback wenn kein Name
                email: email,
                status: 'pending'
            });
            
            document.getElementById('manualName').value = '';
            document.getElementById('manualEmail').value = '';
            
            displayRecipients();
            updateRecipientStats();
        }

        // E-Mail Validierung
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // Test-Daten laden
        function loadTestData() {
            const testData = [
                { name: 'Marcus Braun', email: 'marcusbraun@outlook.com' },
                { name: '', email: 'anna.mueller@example.com' }, // Nur E-Mail
                { name: 'Max Schmidt', email: 'max@example.com' },
                { name: '', email: 'sarah.weber@company.de' } // Nur E-Mail
            ];
            
            testData.forEach(person => {
                if (!recipients.some(r => r.email === person.email)) {
                    recipients.push({
                        id: recipients.length,
                        name: person.name || getNameFromEmail(person.email),
                        email: person.email,
                        status: 'pending'
                    });
                }
            });
            
            displayRecipients();
            updateRecipientStats();
        }

        // Alle Empf√§nger l√∂schen
        function clearRecipients() {
            if (recipients.length === 0) return;
            
            if (confirm('Wirklich alle Empf√§nger l√∂schen?')) {
                recipients = [];
                displayRecipients();
                updateRecipientStats();
            }
        }

        // Empf√§nger anzeigen
        function displayRecipients() {
            const container = document.getElementById('recipientsList');
            
            if (recipients.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Keine Empf√§nger geladen</p>';
                return;
            }

            container.innerHTML = recipients.map((recipient, index) => `
                <div class="recipient">
                    <div>
                        <strong>${recipient.name}</strong><br>
                        <small style="color: #7f8c8d;">${recipient.email}</small>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="status ${recipient.status}">${getStatusText(recipient.status)}</span>
                        <button onclick="removeRecipient(${index})" style="background: #e74c3c; color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer; font-size: 12px;">‚úï</button>
                    </div>
                </div>
            `).join('');
        }

        // Template Parser & Simple Editor Functions
        let currentEditorMode = 'simple';
        let parsedTemplateData = {};

        function switchEditorMode(mode) {
            currentEditorMode = mode;
            
            // Tab styling
            document.getElementById('simpleEditorTab').classList.toggle('active', mode === 'simple');
            document.getElementById('htmlEditorTab').classList.toggle('active', mode === 'html');
            
            // Editor visibility
            document.getElementById('simpleEditor').style.display = mode === 'simple' ? 'block' : 'none';
            document.getElementById('htmlEditor').style.display = mode === 'html' ? 'block' : 'none';
            
            // Auto-parse wenn zu Simple gewechselt wird
            if (mode === 'simple') {
                parseTemplate();
            }
            
            // Vorschau aktualisieren
            updatePreview();
        }

        function parseTemplate() {
            const htmlContent = document.getElementById('htmlContent').value;
            
            if (!htmlContent.trim()) {
                document.getElementById('templateFields').innerHTML = `
                    <p style="text-align: center; color: #6c757d; margin: 20px 0;">
                        Kein HTML Template gefunden. Gehe zum HTML Editor und erstelle oder lade ein Template.
                    </p>
                `;
                return;
            }
            
            // DOM Parser verwenden
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            parsedTemplateData = {
                title: extractTextFromElement(doc, 'title'),
                h1: extractAllTextFromElements(doc, 'h1'),
                h2: extractAllTextFromElements(doc, 'h2'),
                h3: extractAllTextFromElements(doc, 'h3'),
                h4: extractAllTextFromElements(doc, 'h4'),
                paragraphs: extractEditableParagraphs(doc),
                links: extractEditableLinks(doc),
                strong: extractStrongElements(doc)
            };
            
            generateTemplateFields();
        }

        function extractTextFromElement(doc, tagName) {
            const element = doc.querySelector(tagName);
            return element ? element.textContent.trim() : '';
        }

        function extractAllTextFromElements(doc, tagName) {
            const elements = doc.querySelectorAll(tagName);
            return Array.from(elements).map((el, index) => ({
                index: index,
                text: el.textContent.trim(),
                element: el
            })).filter(item => item.text.length > 0);
        }

        function extractEditableParagraphs(doc) {
            const paragraphs = doc.querySelectorAll('p');
            return Array.from(paragraphs).map((p, index) => {
                const text = p.textContent.trim();
                // Paragraphen mit substantiellem Text (nicht nur Links oder sehr kurze Texte)
                if (text.length > 15 && !isOnlyLink(p)) {
                    return {
                        index: index,
                        text: text,
                        element: p
                    };
                }
                return null;
            }).filter(p => p !== null);
        }

        function extractEditableLinks(doc) {
            const links = doc.querySelectorAll('a');
            return Array.from(links).map((link, index) => {
                const text = link.textContent.trim();
                const href = link.getAttribute('href') || '#';
                if (text.length > 0 && text.length < 100) { // Nicht zu lange Link-Texte
                    return {
                        index: index,
                        text: text,
                        href: href,
                        element: link
                    };
                }
                return null;
            }).filter(link => link !== null);
        }

        function extractStrongElements(doc) {
            const strongElements = doc.querySelectorAll('strong, b');
            return Array.from(strongElements).map((strong, index) => {
                const text = strong.textContent.trim();
                if (text.length > 2 && text.length < 50) { // Kurze, wichtige Texte
                    return {
                        index: index,
                        text: text,
                        element: strong
                    };
                }
                return null;
            }).filter(strong => strong !== null);
        }

        function isOnlyLink(element) {
            const links = element.querySelectorAll('a');
            return links.length === 1 && element.textContent.trim() === links[0].textContent.trim();
        }

        function generateTemplateFields() {
            const container = document.getElementById('templateFields');
            let fieldsHTML = '';
            let fieldCount = 0;
            
            // Title
            if (parsedTemplateData.title) {
                fieldCount++;
                fieldsHTML += `
                    <div class="form-group">
                        <label>üìÑ E-Mail Titel:</label>
                        <input type="text" id="field_title" value="${escapeHtml(parsedTemplateData.title)}" onchange="showApplyButton()">
                    </div>
                `;
            }
            
            // H1 √úberschriften
            parsedTemplateData.h1.forEach((h1, index) => {
                fieldCount++;
                fieldsHTML += `
                    <div class="form-group">
                        <label>üì¢ Haupt√ºberschrift ${index + 1}:</label>
                        <input type="text" id="field_h1_${index}" value="${escapeHtml(h1.text)}" onchange="showApplyButton()">
                    </div>
                `;
            });
            
            // H2 √úberschriften
            parsedTemplateData.h2.forEach((h2, index) => {
                fieldCount++;
                fieldsHTML += `
                    <div class="form-group">
                        <label>üìù Unter√ºberschrift ${index + 1}:</label>
                        <input type="text" id="field_h2_${index}" value="${escapeHtml(h2.text)}" onchange="showApplyButton()">
                    </div>
                `;
            });
            
            // H3 √úberschriften
            parsedTemplateData.h3.forEach((h3, index) => {
                fieldCount++;
                fieldsHTML += `
                    <div class="form-group">
                        <label>üè∑Ô∏è Titel ${index + 1}:</label>
                        <input type="text" id="field_h3_${index}" value="${escapeHtml(h3.text)}" onchange="showApplyButton()">
                    </div>
                `;
            });
            
            // H4 √úberschriften
            parsedTemplateData.h4.forEach((h4, index) => {
                fieldCount++;
                fieldsHTML += `
                    <div class="form-group">
                        <label>üîñ Untertitel ${index + 1}:</label>
                        <input type="text" id="field_h4_${index}" value="${escapeHtml(h4.text)}" onchange="showApplyButton()">
                    </div>
                `;
            });
            
            // Paragraphen
            parsedTemplateData.paragraphs.forEach((p, index) => {
                fieldCount++;
                fieldsHTML += `
                    <div class="form-group">
                        <label>üìÑ Textabschnitt ${index + 1}:</label>
                        <textarea id="field_p_${index}" onchange="showApplyButton()" style="min-height: 80px;">${escapeHtml(p.text)}</textarea>
                    </div>
                `;
            });
            
            // Links
            parsedTemplateData.links.forEach((link, index) => {
                fieldCount++;
                fieldsHTML += `
                    <div class="form-group">
                        <label>üîó Link ${index + 1}:</label>
                        <input type="text" id="field_link_text_${index}" placeholder="Link-Text" value="${escapeHtml(link.text)}" onchange="showApplyButton()" style="margin-bottom: 5px;">
                        <input type="url" id="field_link_href_${index}" placeholder="URL" value="${escapeHtml(link.href)}" onchange="showApplyButton()">
                    </div>
                `;
            });
            
            // Strong/Bold Texte
            parsedTemplateData.strong.forEach((strong, index) => {
                fieldCount++;
                fieldsHTML += `
                    <div class="form-group">
                        <label>üí™ Hervorgehobener Text ${index + 1}:</label>
                        <input type="text" id="field_strong_${index}" value="${escapeHtml(strong.text)}" onchange="showApplyButton()">
                    </div>
                `;
            });
            
            if (fieldCount === 0) {
                fieldsHTML = `
                    <div style="text-align: center; color: #6c757d; margin: 20px 0;">
                        <h4>Keine editierbaren Bereiche gefunden</h4>
                        <p>Das Template enth√§lt m√∂glicherweise nur komplexe HTML-Strukturen oder sehr kurze Texte.</p>
                        <p><strong>Tipp:</strong> Verwende den HTML Editor f√ºr komplexe Anpassungen.</p>
                    </div>
                `;
            } else {
                fieldsHTML = `
                    <div class="alert" style="background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; margin-bottom: 20px;">
                        <strong>‚ú® ${fieldCount} editierbare Bereiche gefunden!</strong><br>
                        Bearbeite die Felder und klicke dann auf "‚úÖ √Ñnderungen √ºbernehmen"
                    </div>
                ` + fieldsHTML;
            }
            
            container.innerHTML = fieldsHTML;
            document.getElementById('applyBtn').style.display = fieldCount > 0 ? 'inline-block' : 'none';
        }

        function showApplyButton() {
            document.getElementById('applyBtn').style.display = 'inline-block';
            document.getElementById('applyBtn').textContent = '‚ö° √Ñnderungen √ºbernehmen';
            document.getElementById('applyBtn').style.background = '#f39c12';
        }

        function applyChanges() {
            updateTemplateFromFields();
            document.getElementById('applyBtn').textContent = '‚úÖ √úbernommen!';
            document.getElementById('applyBtn').style.background = '#27ae60';
            setTimeout(() => {
                document.getElementById('applyBtn').textContent = '‚úÖ √Ñnderungen √ºbernehmen';
                document.getElementById('applyBtn').style.background = '#27ae60';
            }, 2000);
        }

        function updateTemplateFromFields() {
            let htmlContent = document.getElementById('htmlContent').value;
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            // Title aktualisieren
            if (parsedTemplateData.title) {
                const newTitle = document.getElementById('field_title')?.value || '';
                const titleElement = doc.querySelector('title');
                if (titleElement) {
                    titleElement.textContent = newTitle;
                }
            }
            
            // H1 aktualisieren
            parsedTemplateData.h1.forEach((h1, index) => {
                const newText = document.getElementById(`field_h1_${index}`)?.value || '';
                const h1Elements = doc.querySelectorAll('h1');
                if (h1Elements[index]) {
                    h1Elements[index].textContent = newText;
                }
            });
            
            // H2 aktualisieren
            parsedTemplateData.h2.forEach((h2, index) => {
                const newText = document.getElementById(`field_h2_${index}`)?.value || '';
                const h2Elements = doc.querySelectorAll('h2');
                if (h2Elements[index]) {
                    h2Elements[index].textContent = newText;
                }
            });
            
            // H3 aktualisieren
            parsedTemplateData.h3.forEach((h3, index) => {
                const newText = document.getElementById(`field_h3_${index}`)?.value || '';
                const h3Elements = doc.querySelectorAll('h3');
                if (h3Elements[index]) {
                    h3Elements[index].textContent = newText;
                }
            });
            
            // H4 aktualisieren
            parsedTemplateData.h4.forEach((h4, index) => {
                const newText = document.getElementById(`field_h4_${index}`)?.value || '';
                const h4Elements = doc.querySelectorAll('h4');
                if (h4Elements[index]) {
                    h4Elements[index].textContent = newText;
                }
            });
            
            // Paragraphen aktualisieren
            parsedTemplateData.paragraphs.forEach((p, index) => {
                const newText = document.getElementById(`field_p_${index}`)?.value || '';
                const allParagraphs = doc.querySelectorAll('p');
                if (allParagraphs[p.index]) {
                    allParagraphs[p.index].textContent = newText;
                }
            });
            
            // Links aktualisieren
            parsedTemplateData.links.forEach((link, index) => {
                const newText = document.getElementById(`field_link_text_${index}`)?.value || '';
                const newHref = document.getElementById(`field_link_href_${index}`)?.value || '#';
                const allLinks = doc.querySelectorAll('a');
                if (allLinks[link.index]) {
                    allLinks[link.index].textContent = newText;
                    allLinks[link.index].setAttribute('href', newHref);
                }
            });
            
            // Strong Texte aktualisieren
            parsedTemplateData.strong.forEach((strong, index) => {
                const newText = document.getElementById(`field_strong_${index}`)?.value || '';
                const allStrong = doc.querySelectorAll('strong, b');
                if (allStrong[strong.index]) {
                    allStrong[strong.index].textContent = newText;
                }
            });
            
            // HTML zur√ºck ins Textarea
            document.getElementById('htmlContent').value = doc.documentElement.outerHTML;
            updatePreview();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Export/Import Funktionen
        function exportConfig() {
            const config = localStorage.getItem('emailConfig');
            const templates = localStorage.getItem('emailTemplates');
            
            const exportData = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                emailConfig: config ? JSON.parse(config) : null,
                emailTemplates: templates ? JSON.parse(templates) : {}
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `email-marketing-backup-${new Date().toLocaleDateString('de-DE').replace(/\./g, '-')}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('importStatus', '‚úÖ Backup erfolgreich heruntergeladen!', 'success');
        }

        function importConfig() {
            const file = document.getElementById('configFile').files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showStatus('importStatus', 'Bitte eine .json Datei ausw√§hlen', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // Validierung der Datenstruktur
                    if (!importData.version) {
                        throw new Error('Ung√ºltige Backup-Datei');
                    }
                    
                    // EmailJS Config wiederherstellen
                    if (importData.emailConfig) {
                        localStorage.setItem('emailConfig', JSON.stringify(importData.emailConfig));
                        loadConfig(); // UI aktualisieren
                    }
                    
                    // Templates wiederherstellen
                    if (importData.emailTemplates) {
                        localStorage.setItem('emailTemplates', JSON.stringify(importData.emailTemplates));
                        loadTemplateList(); // Template-Liste aktualisieren
                    }
                    
                    const configCount = importData.emailConfig ? 1 : 0;
                    const templateCount = Object.keys(importData.emailTemplates || {}).length;
                    
                    showStatus('importStatus', 
                        `‚úÖ Import erfolgreich! ${configCount} Konfiguration und ${templateCount} Templates wiederhergestellt.`, 
                        'success'
                    );
                    
                    // File Input zur√ºcksetzen
                    document.getElementById('configFile').value = '';
                    
                } catch (error) {
                    console.error('Import Error:', error);
                    showStatus('importStatus', `‚ùå Import fehlgeschlagen: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // Template Management
        function saveTemplate() {
            const name = document.getElementById('templateName').value.trim();
            const subject = document.getElementById('subject').value;
            const content = document.getElementById('htmlContent').value;
            
            if (!name) {
                alert('Bitte Template-Namen eingeben');
                return;
            }
            
            const templates = JSON.parse(localStorage.getItem('emailTemplates') || '{}');
            templates[name] = {
                subject: subject,
                content: content,
                created: new Date().toLocaleDateString('de-DE')
            };
            
            localStorage.setItem('emailTemplates', JSON.stringify(templates));
            
            // Template-Liste aktualisieren
            loadTemplateList();
            
            // Erfolgsmeldung
            const originalText = event.target.textContent;
            event.target.textContent = '‚úÖ Gespeichert!';
            event.target.style.background = '#27ae60';
            setTimeout(() => {
                event.target.textContent = originalText;
                event.target.style.background = '#4a90e2';
            }, 2000);
            
            document.getElementById('templateName').value = '';
        }

        function loadTemplateList() {
            const templates = JSON.parse(localStorage.getItem('emailTemplates') || '{}');
            const select = document.getElementById('savedTemplates');
            
            // Aktuelle Optionen l√∂schen (au√üer der ersten)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Templates hinzuf√ºgen
            Object.keys(templates).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (${templates[name].created})`;
                select.appendChild(option);
            });
        }

        function loadSelectedTemplate() {
            const templateName = document.getElementById('savedTemplates').value;
            if (!templateName) return;
            
            const templates = JSON.parse(localStorage.getItem('emailTemplates') || '{}');
            const template = templates[templateName];
            
            if (template) {
                document.getElementById('subject').value = template.subject;
                document.getElementById('htmlContent').value = template.content;
                document.getElementById('templateName').value = templateName;
                updatePreview();
                
                // Template neu parsen wenn im Simple Mode
                if (currentEditorMode === 'simple') {
                    parseTemplate();
                }
            }
        }

        function deleteTemplate() {
            const templateName = document.getElementById('savedTemplates').value;
            if (!templateName) {
                alert('Bitte Template ausw√§hlen');
                return;
            }
            
            if (!confirm(`Template "${templateName}" wirklich l√∂schen?`)) {
                return;
            }
            
            const templates = JSON.parse(localStorage.getItem('emailTemplates') || '{}');
            delete templates[templateName];
            localStorage.setItem('emailTemplates', JSON.stringify(templates));
            
            // UI zur√ºcksetzen
            document.getElementById('savedTemplates').value = '';
            document.getElementById('templateName').value = '';
            loadTemplateList();
        }

        // Einzelnen Empf√§nger entfernen
        function removeRecipient(index) {
            recipients.splice(index, 1);
            // IDs neu zuweisen
            recipients.forEach((recipient, i) => recipient.id = i);
            displayRecipients();
            updateRecipientStats();
        }

        // Status Text
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Wartend',
                'sending': 'Wird gesendet...',
                'sent': 'Gesendet',
                'error': 'Fehler'
            };
            return statusMap[status] || status;
        }

        // Empf√§nger Statistiken
        function updateRecipientStats() {
            const stats = document.getElementById('recipientStats');
            const total = recipients.length;
            const sent = recipients.filter(r => r.status === 'sent').length;
            const errors = recipients.filter(r => r.status === 'error').length;
            const pending = recipients.filter(r => r.status === 'pending').length;

            stats.innerHTML = `
                <div style="display: flex; gap: 20px; margin-top: 20px; justify-content: center;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #4a90e2;">${total}</div>
                        <div style="font-size: 12px; color: #7f8c8d;">Gesamt</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #27ae60;">${sent}</div>
                        <div style="font-size: 12px; color: #7f8c8d;">Gesendet</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${errors}</div>
                        <div style="font-size: 12px; color: #7f8c8d;">Fehler</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${pending}</div>
                        <div style="font-size: 12px; color: #7f8c8d;">Wartend</div>
                    </div>
                </div>
            `;
        }

        // Vorschau aktualisieren
        function updatePreview() {
            const htmlContent = document.getElementById('htmlContent').value;
            const subject = document.getElementById('subject').value;
            
            // Beispiel-Personalisierung
            const personalizedHTML = htmlContent
                .replace(/\{\{name\}\}/g, 'Max Mustermann')
                .replace(/\{\{email\}\}/g, 'max@example.com')
                .replace(/\{\{subject\}\}/g, subject);

            document.getElementById('preview').innerHTML = personalizedHTML;
        }

        // E-Mail personalisieren
        function personalizeContent(content, recipient) {
            return content
                .replace(/\{\{name\}\}/g, recipient.name)
                .replace(/\{\{email\}\}/g, recipient.email)
                .replace(/\{\{subject\}\}/g, document.getElementById('subject').value);
        }
        async function sendEmail(recipient) {
            const config = JSON.parse(localStorage.getItem('emailConfig') || '{}');
            
            if (!config.serviceId || !config.templateId || !config.userId) {
                throw new Error('EmailJS nicht konfiguriert');
            }

            const subject = personalizeContent(document.getElementById('subject').value, recipient);
            const htmlContent = personalizeContent(document.getElementById('htmlContent').value, recipient);

            const templateParams = {
                to_name: recipient.name,
                to_email: recipient.email,
                from_name: config.fromName,
                subject: subject,
                message: htmlContent
            };

            console.log('Sende E-Mail an:', recipient.email);
            console.log('Template Params:', templateParams);

            try {
                const response = await emailjs.send(
                    config.serviceId,
                    config.templateId,
                    templateParams
                );
                
                console.log('EmailJS Response:', response);
                
                if (response.status !== 200) {
                    throw new Error(`EmailJS Error: ${response.status} - ${response.text}`);
                }
                
                return response;
            } catch (error) {
                console.error('EmailJS Error Details:', error);
                throw new Error(`Senden fehlgeschlagen: ${error.message || error}`);
            }
        }

        // Versand starten mit Live-Updates
        async function startSending() {
            const config = localStorage.getItem('emailConfig');
            if (!config) {
                showStatus('sendStatus', 'Bitte zuerst die Konfiguration speichern', 'error');
                return;
            }

            if (recipients.length === 0) {
                showStatus('sendStatus', 'Bitte zuerst Empf√§nger laden', 'error');
                return;
            }

            sendingActive = true;
            sendingStats = { sent: 0, errors: 0, total: recipients.length };
            
            // Alle Status auf "pending" setzen
            recipients.forEach(r => r.status = 'pending');
            updateSendRecipientsList();
            
            document.getElementById('sendBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressText').style.display = 'block';

            const delay = parseInt(document.getElementById('sendSpeed').value);
            
            showStatus('sendStatus', 'Versand gestartet...', 'success');

            for (let i = 0; i < recipients.length && sendingActive; i++) {
                const recipient = recipients[i];
                
                // Status auf "sending" setzen
                recipient.status = 'sending';
                document.getElementById(`status-${i}`).className = 'status pending';
                document.getElementById(`status-${i}`).textContent = 'Wird gesendet...';

                try {
                    await sendEmail(recipient);
                    recipient.status = 'sent';
                    sendingStats.sent++;
                    
                    // Status visuell aktualisieren
                    document.getElementById(`status-${i}`).className = 'status sent';
                    document.getElementById(`status-${i}`).textContent = 'Gesendet ‚úì';
                    
                } catch (error) {
                    recipient.status = 'error';
                    sendingStats.errors++;
                    console.error(`Fehler beim Senden an ${recipient.email}:`, error);
                    
                    // Status visuell aktualisieren
                    document.getElementById(`status-${i}`).className = 'status error';
                    document.getElementById(`status-${i}`).textContent = 'Fehler ‚úó';
                }

                updateProgress();
                displayRecipients(); // Original-Liste auch aktualisieren

                if (i < recipients.length - 1 && sendingActive) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            stopSending();
        }

        // Versand stoppen
        function stopSending() {
            sendingActive = false;
            document.getElementById('sendBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            
            const status = sendingStats.sent === sendingStats.total 
                ? `‚úÖ Alle ${sendingStats.sent} E-Mails erfolgreich gesendet!`
                : `üìä Versand beendet: ${sendingStats.sent} gesendet, ${sendingStats.errors} Fehler`;
            
            showStatus('sendStatus', status, sendingStats.errors === 0 ? 'success' : 'error');
        }

        // Progress Update
        function updateProgress() {
            const progress = ((sendingStats.sent + sendingStats.errors) / sendingStats.total) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = 
                `${sendingStats.sent + sendingStats.errors} von ${sendingStats.total} verarbeitet (${sendingStats.sent} erfolgreich, ${sendingStats.errors} Fehler)`;
        }

        // Status anzeigen
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert ${type}">${message}</div>`;
            setTimeout(() => {
                if (element.innerHTML.includes(message)) {
                    element.innerHTML = '';
                }
            }, 5000);
        }

        // Event Listeners
        document.getElementById('htmlContent').addEventListener('input', function() {
            updatePreview();
            // Re-parse wenn im Simple Mode und √Ñnderungen im HTML Editor
            if (currentEditorMode === 'simple') {
                setTimeout(parseTemplate, 500); // Debounce
            }
        });
        document.getElementById('subject').addEventListener('input', updatePreview);
        
        // Enter-Taste f√ºr manuelle Eingabe
        document.getElementById('manualEmail').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addManualRecipient();
            }
        });
        
        document.getElementById('manualName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('manualEmail').focus();
            }
        });

        // Initial Load
        loadConfig();
        updatePreview();
        loadTemplateList();
        
        // Template automatisch parsen beim Start
        setTimeout(parseTemplate, 100);
    </script>
</body>
</html>