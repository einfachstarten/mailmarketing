<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Mail Marketing Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1400px;
            min-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* === SETUP WIZARD STYLES === */
        .wizard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .wizard-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
        }

        .wizard-header {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .wizard-header h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .wizard-progress {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .progress-step.active {
            background: white;
            color: #4a90e2;
            transform: scale(1.1);
        }

        .progress-step.completed {
            background: #27ae60;
            color: white;
        }

        .wizard-content {
            padding: 30px;
            min-height: 400px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
        }

        .wizard-buttons {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #e9ecef;
        }

        .step-intro {
            text-align: center;
            margin-bottom: 30px;
        }

        .step-intro h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .step-intro p {
            color: #7f8c8d;
            line-height: 1.6;
        }

        .info-box {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .info-box h4 {
            color: #1565c0;
            margin-bottom: 10px;
        }

        .info-box ol {
            margin-left: 20px;
            color: #1565c0;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        .success-box {
            background: #e8f5e8;
            border: 1px solid #a3d9a3;
            color: #2d5a2d;
        }

        .error-box {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            color: #c62828;
        }

        .test-result {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 500;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a90e2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* === MAIN APP STYLES === */
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            position: relative;
        }

        .wizard-trigger {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab.active {
            background: #4a90e2;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #e8f4f8;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #34495e;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e6ed;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .btn {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #357abd;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .btn.secondary {
            background: #95a5a6;
        }

        .btn.success {
            background: #27ae60;
        }

        .btn.danger {
            background: #e74c3c;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            min-height: 500px;
        }

        .editor {
            min-height: 400px;
            max-height: 500px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
        }

        .preview {
            border: 2px solid #e0e6ed;
            border-radius: 6px;
            padding: 20px;
            background: white;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
        }

        .recipient-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e0e6ed;
            border-radius: 6px;
            padding: 15px;
        }

        .recipient {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .recipient:last-child {
            border-bottom: none;
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.pending {
            background: #f39c12;
            color: white;
        }

        .status.sent {
            background: #27ae60;
            color: white;
        }

        .status.error {
            background: #e74c3c;
            color: white;
        }

        .status.sending {
            background: #3498db;
            color: white;
        }

        .progress {
            background: #ecf0f1;
            border-radius: 10px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: #4a90e2;
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            border-radius: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .file-input {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .file-input input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 6px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .file-input:hover .file-input-label {
            background: #e9ecef;
            border-color: #4a90e2;
        }

        .section h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }

        #templateFields {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
        }

        #templateFields .form-group {
            margin-bottom: 15px;
        }

        #templateFields label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }

        #templateFields input,
        #templateFields textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.15s ease-in-out;
        }

        #templateFields input:focus,
        #templateFields textarea:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.25);
        }

        #templateFields textarea {
            resize: vertical;
            line-height: 1.4;
        }

        .tab[type="button"] {
            border: 2px solid #e0e6ed;
            background: white;
        }

        .tab[type="button"].active {
            border-color: #4a90e2;
        }

        .hidden {
            display: none !important;
        }

        .setup-prompt {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            margin: 40px 0;
        }

        .setup-prompt h2 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .setup-prompt p {
            color: #7f8c8d;
            margin-bottom: 25px;
            font-size: 16px;
        }

        @media (max-width: 1250px) {
            .container {
                min-width: auto;
                max-width: 100%;
                padding: 15px;
            }
            
            .grid {
                grid-template-columns: 1fr;
                min-height: auto;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .form-group div[style*="grid-template-columns: 2fr 1fr 1fr 1fr"] {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .section div[style*="grid-template-columns: 1fr 1fr"] {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }

            .wizard-container {
                width: 95%;
                max-height: 90vh;
            }
        }
    </style>
</head>
<body>
    <!-- Setup Wizard -->
    <div id="setupWizard" class="wizard-overlay hidden">
        <div class="wizard-container">
            <div class="wizard-header">
                <h2>🚀 Willkommen beim E-Mail Marketing Tool</h2>
                <p>Lass uns dein Tool in 3 einfachen Schritten einrichten!</p>
                <div class="wizard-progress">
                    <div class="progress-step active" id="step1-indicator">1</div>
                    <div class="progress-step" id="step2-indicator">2</div>
                    <div class="progress-step" id="step3-indicator">3</div>
                </div>
            </div>

            <div class="wizard-content">
                <!-- Schritt 1: EmailJS Account -->
                <div class="wizard-step active" id="wizard-step-1">
                    <div class="step-intro">
                        <h3>📧 EmailJS Account einrichten</h3>
                        <p>Zuerst benötigen wir einen kostenlosen EmailJS Account für den E-Mail-Versand</p>
                    </div>

                    <div class="info-box">
                        <h4>📋 So geht's:</h4>
                        <ol>
                            <li>Gehe zu <a href="https://emailjs.com" target="_blank">emailjs.com</a></li>
                            <li>Erstelle einen kostenlosen Account</li>
                            <li>Verbinde deinen E-Mail-Provider (Gmail, Outlook, etc.)</li>
                            <li>Erstelle ein Email Template mit diesen Variablen:<br>
                                <code>{{to_name}}, {{from_name}}, {{subject}}, {{message}}</code></li>
                            <li>Kopiere die IDs hierher</li>
                        </ol>
                    </div>

                    <div class="form-group">
                        <label for="wizard-serviceId">Service ID:</label>
                        <input type="text" id="wizard-serviceId" placeholder="service_xxxxxxx">
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                            Unter "Email Services" in deinem Dashboard
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="wizard-templateId">Template ID:</label>
                        <input type="text" id="wizard-templateId" placeholder="template_xxxxxxx">
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                            Unter "Email Templates" in deinem Dashboard
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="wizard-userId">Public Key:</label>
                        <input type="text" id="wizard-userId" placeholder="E7m0JpVn9GC6WNcvF">
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                            Unter "Account" > "General" in deinem Dashboard
                        </small>
                    </div>
                </div>

                <!-- Schritt 2: Absender-Info -->
                <div class="wizard-step" id="wizard-step-2">
                    <div class="step-intro">
                        <h3>👤 Absender-Informationen</h3>
                        <p>Wie sollen deine E-Mails signiert werden?</p>
                    </div>

                    <div class="form-group">
                        <label for="wizard-fromName">Dein Name:</label>
                        <input type="text" id="wizard-fromName" placeholder="Anna Müller">
                    </div>

                    <div class="form-group">
                        <label for="wizard-testEmail">Deine E-Mail (für Test):</label>
                        <input type="email" id="wizard-testEmail" placeholder="anna@example.com">
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                            Wir senden eine Test-E-Mail an diese Adresse
                        </small>
                    </div>
                </div>

                <!-- Schritt 3: Test & Fertigstellung -->
                <div class="wizard-step" id="wizard-step-3">
                    <div class="step-intro">
                        <h3>🧪 Konfiguration testen</h3>
                        <p>Lass uns eine Test-E-Mail senden um sicherzustellen, dass alles funktioniert</p>
                    </div>

                    <div id="testEmailSection">
                        <button class="btn success" onclick="sendTestEmail()" id="testEmailBtn">
                            📤 Test-E-Mail senden
                        </button>
                        <div id="testSpinner" class="spinner hidden"></div>
                        <div id="testResult"></div>
                    </div>

                    <div id="setupComplete" class="hidden">
                        <div class="success-box info-box">
                            <h4>🎉 Setup erfolgreich abgeschlossen!</h4>
                            <p>Dein E-Mail Marketing Tool ist jetzt einsatzbereit. Du kannst:</p>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                <li>Templates erstellen und bearbeiten</li>
                                <li>Empfänger-Listen verwalten</li>
                                <li>E-Mail-Kampagnen versenden</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="wizard-buttons">
                <button class="btn secondary" onclick="previousStep()" id="prevBtn" disabled>
                    ← Zurück
                </button>
                <button class="btn" onclick="nextStep()" id="nextBtn">
                    Weiter →
                </button>
                <button class="btn success hidden" onclick="finishSetup()" id="finishBtn">
                    🚀 Tool starten
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>📧 E-Mail Marketing Tool</h1>
            <p>Einfaches Tool für personalisierte E-Mail-Kampagnen</p>
            <div class="wizard-trigger">
                <button class="btn secondary" onclick="showSetupWizard()">
                    ⚙️ Setup Wizard
                </button>
            </div>
        </div>

        <!-- Setup Prompt -->
        <div id="setupPrompt" class="setup-prompt hidden">
            <h2>🔧 Willkommen! Konfiguration erforderlich</h2>
            <p>Dein Tool ist noch nicht konfiguriert. Führe das Setup aus um zu beginnen.</p>
            <button class="btn" onclick="showSetupWizard()">⚙️ Setup Wizard starten</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('template')">📝 Template</button>
            <button class="tab" onclick="showTab('recipients')">👥 Empfänger</button>
            <button class="tab" onclick="showTab('send')">🚀 Versenden</button>
            <button class="tab" onclick="showTab('config')">⚙️ Konfiguration</button>
        </div>

        <!-- Konfiguration Tab -->
        <div id="config" class="tab-content">
            <div class="section">
                <h3>EmailJS Konfiguration</h3>
                <div class="alert" style="background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb;">
                    <strong>💡 Tipp:</strong> Nutze den Setup Wizard für eine geführte Einrichtung!
                </div>
                
                <div class="form-group">
                    <label for="serviceId">Service ID:</label>
                    <input type="text" id="serviceId" placeholder="service_xxxxxxx">
                </div>
                
                <div class="form-group">
                    <label for="templateId">Template ID:</label>
                    <input type="text" id="templateId" placeholder="template_xxxxxxx">
                </div>
                
                <div class="form-group">
                    <label for="userId">Public Key (User ID):</label>
                    <input type="text" id="userId" placeholder="E7m0JpVn9GC6WNcvF">
                </div>
                
                <div class="form-group">
                    <label for="fromName">Dein Name:</label>
                    <input type="text" id="fromName" placeholder="Anna Müller">
                </div>
                
                <button class="btn" onclick="saveConfig()">Konfiguration speichern</button>
                <div id="configStatus"></div>
            </div>

            <div class="section">
                <h3>Konfiguration & Templates sichern</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>📤 Exportieren</h4>
                        <button class="btn" onclick="exportConfig()" style="width: 100%;">
                            💾 Alle Daten herunterladen
                        </button>
                    </div>
                    
                    <div>
                        <h4>📥 Importieren</h4>
                        <div class="file-input">
                            <input type="file" id="configFile" accept=".json" onchange="importConfig()">
                            <div class="file-input-label" style="width: 100%; text-align: center;">
                                📁 .json Datei auswählen
                            </div>
                        </div>
                    </div>
                </div>
                <div id="importStatus"></div>
            </div>
        </div>

        <!-- Template Tab -->
        <div id="template" class="tab-content active">
            <div class="section">
                <h3>E-Mail Template</h3>
                
                <!-- Template Management -->
                <div class="form-group">
                    <label>Template verwalten:</label>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; align-items: end;">
                        <div>
                            <select id="savedTemplates" onchange="loadSelectedTemplate()">
                                <option value="">-- Gespeicherte Templates --</option>
                            </select>
                        </div>
                        <div>
                            <input type="text" id="templateName" placeholder="Template Name">
                        </div>
                        <div>
                            <button class="btn" onclick="saveTemplate()">💾 Speichern</button>
                        </div>
                        <div>
                            <button class="btn danger" onclick="deleteTemplate()">🗑️ Löschen</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="subject">Betreff:</label>
                    <input type="text" id="subject" placeholder="Hallo {{name}}, dein Lerncoaching Update!" value="Hallo {{name}}, dein persönliches Update!">
                </div>
                
                <!-- Editor Mode Tabs -->
                <div class="form-group">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button type="button" class="tab active" id="simpleEditorTab" onclick="switchEditorMode('simple')">📝 Einfacher Editor</button>
                        <button type="button" class="tab" id="htmlEditorTab" onclick="switchEditorMode('html')">🔧 HTML Editor</button>
                    </div>
                </div>
                
                <div class="grid">
                    <div>
                        <!-- Simple Editor -->
                        <div id="simpleEditor">
                            <label>Template bearbeiten:</label>
                            <div id="templateFields">
                                <p style="text-align: center; color: #6c757d; margin: 20px 0;">
                                    Klicke auf "🔄 Template analysieren" um editierbare Bereiche zu finden
                                </p>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button type="button" class="btn" onclick="parseTemplate()">🔄 Template analysieren</button>
                                <button type="button" class="btn success" onclick="applyChanges()" id="applyBtn" style="display: none;">✅ Änderungen übernehmen</button>
                            </div>
                        </div>
                        
                        <!-- HTML Editor -->
                        <div id="htmlEditor" style="display: none;">
                            <label for="htmlContent">HTML Template:</label>
                            <textarea id="htmlContent" class="editor" placeholder="Dein HTML Template hier..."><!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sommerkurse 2025</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f4f4f4;">
    <div style="max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px;">
        <h1 style="color: #333; border-bottom: 3px solid #4a90e2; padding-bottom: 10px;">
            Hallo {{name}}! 👋
        </h1>
        
        <h2 style="color: #4a90e2; margin-top: 25px;">
            Deine persönlichen Lernziele
        </h2>
        
        <p style="font-size: 16px; color: #555;">
            Ich hoffe, es geht dir gut und du kommst mit deinem Lernprojekt gut voran!
        </p>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="color: #4a90e2; margin-top: 0;">📚 Dein persönlicher Lerntipp:</h3>
            <p style="margin-bottom: 0;">
                Denk daran: Kleine, regelmäßige Lerneinheiten sind oft effektiver als lange Marathonsitzungen. 
                Plane dir heute 15 Minuten für dein Lernziel ein!
            </p>
        </div>
        
        <p style="color: #555;">
            Falls du Fragen hast oder Unterstützung brauchst, melde dich gerne bei mir.
        </p>
        
        <p style="color: #555;">
            Liebe Grüße,<br>
            <strong>Anna</strong>
        </p>
        
        <hr style="border: none; border-top: 1px solid #eee; margin: 30px 0;">
        
        <p style="font-size: 12px; color: #888; text-align: center;">
            Du erhältst diese E-Mail, weil du dich für mein Lerncoaching interessiert hast.<br>
            <a href="#" style="color: #4a90e2;">Abmelden</a>
        </p>
    </div>
</body>
</html></textarea>
                        </div>
                    </div>
                    <div>
                        <label>Live Vorschau:</label>
                        <small style="color: #f39c12; display: block; margin-bottom: 5px;">
                            ⚠️ Die Vorschau kann leicht von der finalen E-Mail abweichen
                        </small>
                        <div id="preview" class="preview">
                            Vorschau wird hier angezeigt...
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="updatePreview()">Vorschau aktualisieren</button>
            </div>
        </div>

        <!-- Empfänger Tab -->
        <div id="recipients" class="tab-content">
            <div class="section">
                <h3>Empfänger Liste</h3>
                
                <!-- Manuelle Eingabe -->
                <div class="form-group">
                    <label>Empfänger manuell hinzufügen:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                        <div>
                            <input type="text" id="manualName" placeholder="Name (optional)">
                        </div>
                        <div>
                            <input type="email" id="manualEmail" placeholder="E-Mail">
                        </div>
                        <div>
                            <button class="btn" onclick="addManualRecipient()">➕ Hinzufügen</button>
                        </div>
                    </div>
                </div>
                
                <!-- CSV Upload -->
                <div class="form-group">
                    <label>CSV-Datei hochladen:</label>
                    <div class="file-input">
                        <input type="file" id="csvFile" accept=".csv" onchange="loadCSV()">
                        <div class="file-input-label">
                            📁 CSV-Datei auswählen
                        </div>
                    </div>
                    <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                        Format: <strong>Nur E-Mails:</strong> eine pro Zeile <strong>ODER</strong> <strong>Name + E-Mail:</strong> zwei Spalten
                    </small>
                </div>
                
                <!-- Aktionen -->
                <div class="form-group">
                    <button class="btn" onclick="loadTestData()">🧪 Test-Daten laden</button>
                    <button class="btn danger" onclick="clearRecipients()" style="margin-left: 10px;">🗑️ Alle löschen</button>
                </div>
                
                <div id="recipientsList" class="recipient-list">
                    <p style="text-align: center; color: #7f8c8d;">Keine Empfänger geladen</p>
                </div>
                <div id="recipientStats"></div>
            </div>
        </div>

        <!-- Versenden Tab -->
        <div id="send" class="tab-content">
            <div class="section">
                <h3>E-Mail Kampagne versenden</h3>
                <div id="sendStatus"></div>
                
                <!-- Empfänger Übersicht -->
                <div class="form-group">
                    <label>Empfänger Übersicht:</label>
                    <div id="sendRecipientsList" class="recipient-list" style="max-height: 200px;">
                        <p style="text-align: center; color: #7f8c8d;">Keine Empfänger geladen</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Versand-Geschwindigkeit:</label>
                    <select id="sendSpeed">
                        <option value="2000">Langsam (1 E-Mail alle 2 Sekunden)</option>
                        <option value="1000" selected>Normal (1 E-Mail pro Sekunde)</option>
                        <option value="500">Schnell (2 E-Mails pro Sekunde)</option>
                    </select>
                </div>
                
                <div class="progress" id="progressContainer" style="display: none;">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div id="progressText" style="display: none; text-align: center; margin-top: 10px;"></div>
                
                <button class="btn success" id="sendBtn" onclick="startSending()">📤 Kampagne starten</button>
                <button class="btn danger" id="stopBtn" onclick="stopSending()" style="display: none;">⏹️ Stoppen</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        // Globale Variablen
        let recipients = [];
        let sendingActive = false;
        let sendingStats = { sent: 0, errors: 0, total: 0 };
        let currentWizardStep = 1;

        // === SETUP WIZARD ===
        function showSetupWizard() {
            currentWizardStep = 1;
            updateWizardStep();
            document.getElementById('setupWizard').classList.remove('hidden');
            
            // Reset wizard
            document.getElementById('setupComplete').classList.add('hidden');
            document.getElementById('testEmailSection').style.display = 'block';
            document.getElementById('testResult').innerHTML = '';
            
            // Load existing config if any
            loadWizardConfig();
        }

        function nextStep() {
            if (currentWizardStep === 1) {
                if (!validateStep1()) return;
            } else if (currentWizardStep === 2) {
                if (!validateStep2()) return;
            }

            currentWizardStep++;
            updateWizardStep();
        }

        function previousStep() {
            currentWizardStep--;
            updateWizardStep();
        }

        function updateWizardStep() {
            // Steps ausblenden
            document.querySelectorAll('.wizard-step').forEach(step => {
                step.classList.remove('active');
            });

            // Progress indicators aktualisieren
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                indicator.classList.remove('active', 'completed');
                
                if (i < currentWizardStep) {
                    indicator.classList.add('completed');
                } else if (i === currentWizardStep) {
                    indicator.classList.add('active');
                }
            }

            // Aktuelle Step anzeigen
            document.getElementById(`wizard-step-${currentWizardStep}`).classList.add('active');

            // Buttons aktualisieren
            document.getElementById('prevBtn').disabled = currentWizardStep === 1;
            document.getElementById('nextBtn').style.display = currentWizardStep === 3 ? 'none' : 'inline-block';
            document.getElementById('finishBtn').style.display = currentWizardStep === 3 ? 'inline-block' : 'none';
        }

        function validateStep1() {
            const serviceId = document.getElementById('wizard-serviceId').value.trim();
            const templateId = document.getElementById('wizard-templateId').value.trim();
            const userId = document.getElementById('wizard-userId').value.trim();

            if (!serviceId || !templateId || !userId) {
                alert('Bitte alle EmailJS-Felder ausfüllen');
                return false;
            }

            try {
                emailjs.init(userId);
                return true;
            } catch (error) {
                alert('Fehler bei EmailJS Initialisierung: ' + error.message);
                return false;
            }
        }

        function validateStep2() {
            const fromName = document.getElementById('wizard-fromName').value.trim();
            const testEmail = document.getElementById('wizard-testEmail').value.trim();

            if (!fromName) {
                alert('Bitte deinen Namen eingeben');
                return false;
            }

            if (!testEmail || !isValidEmail(testEmail)) {
                alert('Bitte gültige E-Mail-Adresse eingeben');
                return false;
            }

            return true;
        }

        async function sendTestEmail() {
            const testBtn = document.getElementById('testEmailBtn');
            const spinner = document.getElementById('testSpinner');
            const result = document.getElementById('testResult');

            testBtn.disabled = true;
            spinner.classList.remove('hidden');
            result.innerHTML = '';

            const serviceId = document.getElementById('wizard-serviceId').value;
            const templateId = document.getElementById('wizard-templateId').value;
            const fromName = document.getElementById('wizard-fromName').value;
            const testEmail = document.getElementById('wizard-testEmail').value;

            const templateParams = {
                to_name: fromName,
                to_email: testEmail,
                from_name: fromName,
                subject: 'Test E-Mail - Setup erfolgreich!',
                message: `
                    <h2>🎉 Glückwunsch!</h2>
                    <p>Dein E-Mail Marketing Tool ist erfolgreich eingerichtet und funktioniert.</p>
                    <p>Du kannst jetzt personalisierte E-Mail-Kampagnen versenden!</p>
                    <p>Liebe Grüße,<br><strong>${fromName}</strong></p>
                `
            };

            try {
                const response = await emailjs.send(serviceId, templateId, templateParams);
                
                if (response.status === 200) {
                    result.innerHTML = `
                        <div class="test-result success-box">
                            ✅ Test-E-Mail erfolgreich gesendet! Prüfe dein Postfach.
                        </div>
                    `;
                    
                    // Konfiguration speichern
                    saveWizardConfig();
                    
                    // Setup als abgeschlossen markieren
                    document.getElementById('setupComplete').classList.remove('hidden');
                    document.getElementById('testEmailSection').style.display = 'none';
                    
                } else {
                    throw new Error(`Unerwarteter Status: ${response.status}`);
                }
            } catch (error) {
                result.innerHTML = `
                    <div class="test-result error-box">
                        ❌ Fehler beim Senden: ${error.message}<br>
                        Prüfe deine EmailJS-Konfiguration.
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        function saveWizardConfig() {
            const config = {
                serviceId: document.getElementById('wizard-serviceId').value,
                templateId: document.getElementById('wizard-templateId').value,
                userId: document.getElementById('wizard-userId').value,
                fromName: document.getElementById('wizard-fromName').value,
                setupCompleted: true
            };

            localStorage.setItem('emailConfig', JSON.stringify(config));
            
            // Main app config auch updaten
            document.getElementById('serviceId').value = config.serviceId;
            document.getElementById('templateId').value = config.templateId;
            document.getElementById('userId').value = config.userId;
            document.getElementById('fromName').value = config.fromName;
        }

        function finishSetup() {
            document.getElementById('setupWizard').classList.add('hidden');
            document.getElementById('setupPrompt').classList.add('hidden');
            loadMainAppData();
        }

        function loadWizardConfig() {
            const config = localStorage.getItem('emailConfig');
            if (config) {
                const data = JSON.parse(config);
                document.getElementById('wizard-serviceId').value = data.serviceId || '';
                document.getElementById('wizard-templateId').value = data.templateId || '';
                document.getElementById('wizard-userId').value = data.userId || '';
                document.getElementById('wizard-fromName').value = data.fromName || '';
            }
        }

        // === MAIN APP FUNCTIONS ===
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'send') {
                updateSendRecipientsList();
            }
        }

        function loadMainAppData() {
            const config = localStorage.getItem('emailConfig');
            if (!config) {
                document.getElementById('setupPrompt').classList.remove('hidden');
                return;
            }

            const data = JSON.parse(config);
            if (data.setupCompleted && data.userId) {
                emailjs.init(data.userId);
                document.getElementById('setupPrompt').classList.add('hidden');
                loadConfig();
            } else {
                document.getElementById('setupPrompt').classList.remove('hidden');
            }
        }

        // Empfänger Liste für Versenden-Tab
        function updateSendRecipientsList() {
            const container = document.getElementById('sendRecipientsList');
            
            if (recipients.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Keine Empfänger geladen - gehe zu "Empfänger" Tab</p>';
                return;
            }

            container.innerHTML = recipients.map((recipient, index) => `
                <div class="recipient">
                    <div>
                        <strong>${recipient.name}</strong><br>
                        <small style="color: #7f8c8d;">${recipient.email}</small>
                    </div>
                    <span class="status ${recipient.status}" id="status-${index}">${getStatusText(recipient.status)}</span>
                </div>
            `).join('');
        }

        // Konfiguration speichern
        function saveConfig() {
            const serviceId = document.getElementById('serviceId').value;
            const templateId = document.getElementById('templateId').value;
            const userId = document.getElementById('userId').value;
            const fromName = document.getElementById('fromName').value;

            if (!serviceId || !templateId || !userId || !fromName) {
                showStatus('configStatus', 'Bitte alle Felder ausfüllen', 'error');
                return;
            }

            emailjs.init(userId);

            localStorage.setItem('emailConfig', JSON.stringify({
                serviceId, templateId, userId, fromName, setupCompleted: true
            }));

            showStatus('configStatus', 'Konfiguration gespeichert!', 'success');
            document.getElementById('setupPrompt').classList.add('hidden');
        }

        function loadConfig() {
            const config = localStorage.getItem('emailConfig');
            if (config) {
                const { serviceId, templateId, userId, fromName } = JSON.parse(config);
                document.getElementById('serviceId').value = serviceId || '';
                document.getElementById('templateId').value = templateId || '';
                document.getElementById('userId').value = userId || '';
                document.getElementById('fromName').value = fromName || '';
                
                if (userId) {
                    emailjs.init(userId);
                }
            }
        }

        // === CSV & RECIPIENTS ===
        function loadCSV() {
            const file = document.getElementById('csvFile').files[0];
            if (!file) return;

            Papa.parse(file, {
                complete: function(results) {
                    const processedRecipients = [];
                    const errors = [];
                    
                    results.data.forEach((row, rowIndex) => {
                        if (!row || row.length === 0 || (row.length === 1 && !row[0].trim())) {
                            return;
                        }
                        
                        let name = '';
                        let email = '';
                        
                        if (row.length === 1) {
                            email = row[0].trim();
                            name = getNameFromEmail(email);
                        } else if (row.length >= 2) {
                            name = row[0].trim() || getNameFromEmail(row[1].trim());
                            email = row[1].trim();
                        }
                        
                        if (email && isValidEmail(email)) {
                            if (!processedRecipients.some(r => r.email === email)) {
                                processedRecipients.push({
                                    id: processedRecipients.length,
                                    name: name,
                                    email: email,
                                    status: 'pending'
                                });
                            } else {
                                errors.push(`Zeile ${rowIndex + 1}: Doppelte E-Mail "${email}"`);
                            }
                        } else {
                            errors.push(`Zeile ${rowIndex + 1}: Ungültige E-Mail "${email}"`);
                        }
                    });
                    
                    recipients = processedRecipients;
                    
                    if (errors.length > 0) {
                        const errorMsg = `CSV geladen mit ${errors.length} Fehlern:\n${errors.slice(0, 5).join('\n')}${errors.length > 5 ? '\n...' : ''}`;
                        alert(errorMsg);
                    }
                    
                    displayRecipients();
                    updateRecipientStats();
                },
                header: false,
                skipEmptyLines: true,
                delimiter: ',',
                quotes: true
            });
        }

        function getNameFromEmail(email) {
            const localPart = email.split('@')[0];
            const nameParts = localPart.split(/[._-]+/);
            return nameParts
                .map(part => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase())
                .join(' ');
        }

        function addManualRecipient() {
            const name = document.getElementById('manualName').value.trim();
            const email = document.getElementById('manualEmail').value.trim();
            
            if (!email) {
                alert('Bitte E-Mail-Adresse eingeben');
                return;
            }
            
            if (!isValidEmail(email)) {
                alert('Bitte gültige E-Mail-Adresse eingeben');
                return;
            }
            
            if (recipients.some(r => r.email === email)) {
                alert('E-Mail-Adresse bereits vorhanden');
                return;
            }
            
            recipients.push({
                id: recipients.length,
                name: name || getNameFromEmail(email),
                email: email,
                status: 'pending'
            });
            
            document.getElementById('manualName').value = '';
            document.getElementById('manualEmail').value = '';
            
            displayRecipients();
            updateRecipientStats();
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function loadTestData() {
            const testData = [
                { name: 'Marcus Braun', email: 'marcusbraun@outlook.com' },
                { name: '', email: 'anna.mueller@example.com' },
                { name: 'Max Schmidt', email: 'max@example.com' },
                { name: '', email: 'sarah.weber@company.de' }
            ];
            
            testData.forEach(person => {
                if (!recipients.some(r => r.email === person.email)) {
                    recipients.push({
                        id: recipients.length,
                        name: person.name || getNameFromEmail(person.email),
                        email: person.email,
                        status: 'pending'
                    });
                }
            });
            
            displayRecipients();
            updateRecipientStats();
        }

        function clearRecipients() {
            if (recipients.length === 0) return;
            
            if (confirm('Wirklich alle Empfänger löschen?')) {
                recipients = [];
                displayRecipients();
                updateRecipientStats();
            }
        }

        function displayRecipients() {
            const container = document.getElementById('recipientsList');
            
            if (recipients.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Keine Empfänger geladen</p>';
                return;
            }

            container.innerHTML = recipients.map((recipient, index) => `
                <div class="recipient">
                    <div>
                        <strong>${recipient.name}</strong><br>
                        <small style="color: #7f8c8d;">${recipient.email}</small>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="status ${recipient.status}">${getStatusText(recipient.status)}</span>
                        <button onclick="removeRecipient(${index})" style="background: #e74c3c; color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer; font-size: 12px;">✕</button>
                    </div>
                </div>
            `).join('');
        }

        function removeRecipient(index) {
            recipients.splice(index, 1);
            recipients.forEach((recipient, i) => recipient.id = i);
            displayRecipients();
            updateRecipientStats();
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Wartend',
                'sending': 'Wird gesendet...',
                'sent': 'Gesendet',
                'error': 'Fehler'
            };
            return statusMap[status] || status;
        }

        function updateRecipientStats() {
            const stats = document.getElementById('recipientStats');
            const total = recipients.length;
            const sent = recipients.filter(r => r.status === 'sent').length;
            const errors = recipients.filter(r => r.status === 'error').length;
            const pending = recipients.filter(r => r.status === 'pending').length;

            stats.innerHTML = `
                <div style="display: flex; gap: 20px; margin-top: 20px; justify-content: center;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #4a90e2;">${total}</div>
                        <div style="font-size: 12px; color: #7f8c8d;">Gesamt</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #27ae60;">${sent}</div>
                        <div style="font-size: 12px; color: #7f8c8d;">Gesendet</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${errors}</div>
                        <div style="font-size: 12px; color: #7f8c8d;">Fehler</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${pending}</div>
                        <div style="font-size: 12px; color: #7f8c8d;">Wartend</div>
                    </div>
                </div>
            `;
        }

        // === TEMPLATE FUNCTIONS ===
        let currentEditorMode = 'simple';
        let parsedTemplateData = {};

        function switchEditorMode(mode) {
            currentEditorMode = mode;
            
            document.getElementById('simpleEditorTab').classList.toggle('active', mode === 'simple');
            document.getElementById('htmlEditorTab').classList.toggle('active', mode === 'html');
            
            document.getElementById('simpleEditor').style.display = mode === 'simple' ? 'block' : 'none';
            document.getElementById('htmlEditor').style.display = mode === 'html' ? 'block' : 'none';
            
            if (mode === 'simple') {
                parseTemplate();
            }
            
            updatePreview();
        }

        function parseTemplate() {
            const htmlContent = document.getElementById('htmlContent').value;
            
            if (!htmlContent.trim()) {
                document.getElementById('templateFields').innerHTML = `
                    <p style="text-align: center; color: #6c757d; margin: 20px 0;">
                        Kein HTML Template gefunden. Gehe zum HTML Editor und erstelle oder lade ein Template.
                    </p>
                `;
                return;
            }
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            parsedTemplateData = {
                title: extractTextFromElement(doc, 'title'),
                h1: extractAllTextFromElements(doc, 'h1'),
                h2: extractAllTextFromElements(doc, 'h2'),
                h3: extractAllTextFromElements(doc, 'h3'),
                paragraphs: extractEditableParagraphs(doc)
            };
            
            generateTemplateFields();
        }

        function extractTextFromElement(doc, tagName) {
            const element = doc.querySelector(tagName);
            return element ? element.textContent.trim() : '';
        }

        function extractAllTextFromElements(doc, tagName) {
            const elements = doc.querySelectorAll(tagName);
            return Array.from(elements).map((el, index) => ({
                index: index,
                text: el.textContent.trim(),
                element: el
            })).filter(item => item.text.length > 0);
        }

        function extractEditableParagraphs(doc) {
            const paragraphs = doc.querySelectorAll('p');
            return Array.from(paragraphs).map((p, index) => {
                const text = p.textContent.trim();
                if (text.length > 15) {
                    return {
                        index: index,
                        text: text,
                        element: p
                    };
                }
                return null;
            }).filter(p => p !== null);
        }

        function generateTemplateFields() {
            const container = document.getElementById('templateFields');
            let fieldsHTML = '';
            let fieldCount = 0;
            
            if (parsedTemplateData.title) {
                fieldCount++;
                fieldsHTML += `
                    <div class="form-group">
                        <label>📄 E-Mail Titel:</label>
                        <input type="text" id="field_title" value="${escapeHtml(parsedTemplateData.title)}" onchange="showApplyButton()">
                    </div>
                `;
            }
            
            parsedTemplateData.h1.forEach((h1, index) => {
                fieldCount++;
                fieldsHTML += `
                    <div class="form-group">
                        <label>📢 Hauptüberschrift ${index + 1}:</label>
                        <input type="text" id="field_h1_${index}" value="${escapeHtml(h1.text)}" onchange="showApplyButton()">
                    </div>
                `;
            });
            
            parsedTemplateData.h2.forEach((h2, index) => {
                fieldCount++;
                fieldsHTML += `
                    <div class="form-group">
                        <label>📝 Unterüberschrift ${index + 1}:</label>
                        <input type="text" id="field_h2_${index}" value="${escapeHtml(h2.text)}" onchange="showApplyButton()">
                    </div>
                `;
            });
            
            parsedTemplateData.h3.forEach((h3, index) => {
                fieldCount++;
                fieldsHTML += `
                    <div class="form-group">
                        <label>🏷️ Titel ${index + 1}:</label>
                        <input type="text" id="field_h3_${index}" value="${escapeHtml(h3.text)}" onchange="showApplyButton()">
                    </div>
                `;
            });
            
            parsedTemplateData.paragraphs.forEach((p, index) => {
                fieldCount++;
                fieldsHTML += `
                    <div class="form-group">
                        <label>📄 Textabschnitt ${index + 1}:</label>
                        <textarea id="field_p_${index}" onchange="showApplyButton()" style="min-height: 80px;">${escapeHtml(p.text)}</textarea>
                    </div>
                `;
            });
            
            if (fieldCount === 0) {
                fieldsHTML = `
                    <div style="text-align: center; color: #6c757d; margin: 20px 0;">
                        <h4>Keine editierbaren Bereiche gefunden</h4>
                        <p>Verwende den HTML Editor für komplexe Anpassungen.</p>
                    </div>
                `;
            } else {
                fieldsHTML = `
                    <div class="alert" style="background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; margin-bottom: 20px;">
                        <strong>✨ ${fieldCount} editierbare Bereiche gefunden!</strong><br>
                        Bearbeite die Felder und klicke dann auf "✅ Änderungen übernehmen"
                    </div>
                ` + fieldsHTML;
            }
            
            container.innerHTML = fieldsHTML;
            document.getElementById('applyBtn').style.display = fieldCount > 0 ? 'inline-block' : 'none';
        }

        function showApplyButton() {
            document.getElementById('applyBtn').style.display = 'inline-block';
            document.getElementById('applyBtn').textContent = '⚡ Änderungen übernehmen';
            document.getElementById('applyBtn').style.background = '#f39c12';
        }

        function applyChanges() {
            updateTemplateFromFields();
            document.getElementById('applyBtn').textContent = '✅ Übernommen!';
            document.getElementById('applyBtn').style.background = '#27ae60';
            setTimeout(() => {
                document.getElementById('applyBtn').textContent = '✅ Änderungen übernehmen';
                document.getElementById('applyBtn').style.background = '#27ae60';
            }, 2000);
        }

        function updateTemplateFromFields() {
            let htmlContent = document.getElementById('htmlContent').value;
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            if (parsedTemplateData.title) {
                const newTitle = document.getElementById('field_title')?.value || '';
                const titleElement = doc.querySelector('title');
                if (titleElement) {
                    titleElement.textContent = newTitle;
                }
            }
            
            parsedTemplateData.h1.forEach((h1, index) => {
                const newText = document.getElementById(`field_h1_${index}`)?.value || '';
                const h1Elements = doc.querySelectorAll('h1');
                if (h1Elements[index]) {
                    h1Elements[index].textContent = newText;
                }
            });
            
            parsedTemplateData.h2.forEach((h2, index) => {
                const newText = document.getElementById(`field_h2_${index}`)?.value || '';
                const h2Elements = doc.querySelectorAll('h2');
                if (h2Elements[index]) {
                    h2Elements[index].textContent = newText;
                }
            });
            
            parsedTemplateData.h3.forEach((h3, index) => {
                const newText = document.getElementById(`field_h3_${index}`)?.value || '';
                const h3Elements = doc.querySelectorAll('h3');
                if (h3Elements[index]) {
                    h3Elements[index].textContent = newText;
                }
            });
            
            parsedTemplateData.paragraphs.forEach((p, index) => {
                const newText = document.getElementById(`field_p_${index}`)?.value || '';
                const allParagraphs = doc.querySelectorAll('p');
                if (allParagraphs[p.index]) {
                    allParagraphs[p.index].textContent = newText;
                }
            });
            
            document.getElementById('htmlContent').value = doc.documentElement.outerHTML;
            updatePreview();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Template Management
        function saveTemplate() {
            const name = document.getElementById('templateName').value.trim();
            const subject = document.getElementById('subject').value;
            const content = document.getElementById('htmlContent').value;
            
            if (!name) {
                alert('Bitte Template-Namen eingeben');
                return;
            }
            
            const templates = JSON.parse(localStorage.getItem('emailTemplates') || '{}');
            templates[name] = {
                subject: subject,
                content: content,
                created: new Date().toLocaleDateString('de-DE')
            };
            
            localStorage.setItem('emailTemplates', JSON.stringify(templates));
            
            loadTemplateList();
            
            const originalText = event.target.textContent;
            event.target.textContent = '✅ Gespeichert!';
            event.target.style.background = '#27ae60';
            setTimeout(() => {
                event.target.textContent = originalText;
                event.target.style.background = '#4a90e2';
            }, 2000);
            
            document.getElementById('templateName').value = '';
        }

        function loadTemplateList() {
            const templates = JSON.parse(localStorage.getItem('emailTemplates') || '{}');
            const select = document.getElementById('savedTemplates');
            
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            Object.keys(templates).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (${templates[name].created})`;
                select.appendChild(option);
            });
        }

        function loadSelectedTemplate() {
            const templateName = document.getElementById('savedTemplates').value;
            if (!templateName) return;
            
            const templates = JSON.parse(localStorage.getItem('emailTemplates') || '{}');
            const template = templates[templateName];
            
            if (template) {
                document.getElementById('subject').value = template.subject;
                document.getElementById('htmlContent').value = template.content;
                document.getElementById('templateName').value = templateName;
                updatePreview();
                
                if (currentEditorMode === 'simple') {
                    parseTemplate();
                }
            }
        }

        function deleteTemplate() {
            const templateName = document.getElementById('savedTemplates').value;
            if (!templateName) {
                alert('Bitte Template auswählen');
                return;
            }
            
            if (!confirm(`Template "${templateName}" wirklich löschen?`)) {
                return;
            }
            
            const templates = JSON.parse(localStorage.getItem('emailTemplates') || '{}');
            delete templates[templateName];
            localStorage.setItem('emailTemplates', JSON.stringify(templates));
            
            document.getElementById('savedTemplates').value = '';
            document.getElementById('templateName').value = '';
            loadTemplateList();
        }

        // Export/Import
        function exportConfig() {
            const config = localStorage.getItem('emailConfig');
            const templates = localStorage.getItem('emailTemplates');
            
            const exportData = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                emailConfig: config ? JSON.parse(config) : null,
                emailTemplates: templates ? JSON.parse(templates) : {}
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `email-marketing-backup-${new Date().toLocaleDateString('de-DE').replace(/\./g, '-')}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('importStatus', '✅ Backup erfolgreich heruntergeladen!', 'success');
        }

        function importConfig() {
            const file = document.getElementById('configFile').files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showStatus('importStatus', 'Bitte eine .json Datei auswählen', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.version) {
                        throw new Error('Ungültige Backup-Datei');
                    }
                    
                    if (importData.emailConfig) {
                        localStorage.setItem('emailConfig', JSON.stringify(importData.emailConfig));
                        loadConfig();
                    }
                    
                    if (importData.emailTemplates) {
                        localStorage.setItem('emailTemplates', JSON.stringify(importData.emailTemplates));
                        loadTemplateList();
                    }
                    
                    const configCount = importData.emailConfig ? 1 : 0;
                    const templateCount = Object.keys(importData.emailTemplates || {}).length;
                    
                    showStatus('importStatus', 
                        `✅ Import erfolgreich! ${configCount} Konfiguration und ${templateCount} Templates wiederhergestellt.`, 
                        'success'
                    );
                    
                    document.getElementById('configFile').value = '';
                    
                } catch (error) {
                    console.error('Import Error:', error);
                    showStatus('importStatus', `❌ Import fehlgeschlagen: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function updatePreview() {
            const htmlContent = document.getElementById('htmlContent').value;
            const subject = document.getElementById('subject').value;
            
            const personalizedHTML = htmlContent
                .replace(/\{\{name\}\}/g, 'Max Mustermann')
                .replace(/\{\{email\}\}/g, 'max@example.com')
                .replace(/\{\{subject\}\}/g, subject);

            document.getElementById('preview').innerHTML = personalizedHTML;
        }

        function personalizeContent(content, recipient) {
            return content
                .replace(/\{\{name\}\}/g, recipient.name)
                .replace(/\{\{email\}\}/g, recipient.email)
                .replace(/\{\{subject\}\}/g, document.getElementById('subject').value);
        }

        // === SENDING ===
        async function sendEmail(recipient) {
            const config = JSON.parse(localStorage.getItem('emailConfig') || '{}');
            
            if (!config.serviceId || !config.templateId || !config.userId) {
                throw new Error('EmailJS nicht konfiguriert');
            }

            const subject = personalizeContent(document.getElementById('subject').value, recipient);
            const htmlContent = personalizeContent(document.getElementById('htmlContent').value, recipient);

            const templateParams = {
                to_name: recipient.name,
                to_email: recipient.email,
                from_name: config.fromName,
                subject: subject,
                message: htmlContent
            };

            try {
                const response = await emailjs.send(
                    config.serviceId,
                    config.templateId,
                    templateParams
                );
                
                if (response.status !== 200) {
                    throw new Error(`EmailJS Error: ${response.status} - ${response.text}`);
                }
                
                return response;
            } catch (error) {
                console.error('EmailJS Error Details:', error);
                throw new Error(`Senden fehlgeschlagen: ${error.message || error}`);
            }
        }

        async function startSending() {
            const config = localStorage.getItem('emailConfig');
            if (!config) {
                showStatus('sendStatus', 'Bitte zuerst die Konfiguration speichern', 'error');
                return;
            }

            if (recipients.length === 0) {
                showStatus('sendStatus', 'Bitte zuerst Empfänger laden', 'error');
                return;
            }

            sendingActive = true;
            sendingStats = { sent: 0, errors: 0, total: recipients.length };
            
            recipients.forEach(r => r.status = 'pending');
            updateSendRecipientsList();
            
            document.getElementById('sendBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressText').style.display = 'block';

            const delay = parseInt(document.getElementById('sendSpeed').value);
            
            showStatus('sendStatus', 'Versand gestartet...', 'success');

            for (let i = 0; i < recipients.length && sendingActive; i++) {
                const recipient = recipients[i];
                
                recipient.status = 'sending';
                document.getElementById(`status-${i}`).className = 'status pending';
                document.getElementById(`status-${i}`).textContent = 'Wird gesendet...';

                try {
                    await sendEmail(recipient);
                    recipient.status = 'sent';
                    sendingStats.sent++;
                    
                    document.getElementById(`status-${i}`).className = 'status sent';
                    document.getElementById(`status-${i}`).textContent = 'Gesendet ✓';
                    
                } catch (error) {
                    recipient.status = 'error';
                    sendingStats.errors++;
                    console.error(`Fehler beim Senden an ${recipient.email}:`, error);
                    
                    document.getElementById(`status-${i}`).className = 'status error';
                    document.getElementById(`status-${i}`).textContent = 'Fehler ✗';
                }

                updateProgress();
                displayRecipients();

                if (i < recipients.length - 1 && sendingActive) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            stopSending();
        }

        function stopSending() {
            sendingActive = false;
            document.getElementById('sendBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            
            const status = sendingStats.sent === sendingStats.total 
                ? `✅ Alle ${sendingStats.sent} E-Mails erfolgreich gesendet!`
                : `📊 Versand beendet: ${sendingStats.sent} gesendet, ${sendingStats.errors} Fehler`;
            
            showStatus('sendStatus', status, sendingStats.errors === 0 ? 'success' : 'error');
        }

        function updateProgress() {
            const progress = ((sendingStats.sent + sendingStats.errors) / sendingStats.total) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = 
                `${sendingStats.sent + sendingStats.errors} von ${sendingStats.total} verarbeitet (${sendingStats.sent} erfolgreich, ${sendingStats.errors} Fehler)`;
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert ${type}">${message}</div>`;
            setTimeout(() => {
                if (element.innerHTML.includes(message)) {
                    element.innerHTML = '';
                }
            }, 5000);
        }

        // Event Listeners
        document.getElementById('htmlContent').addEventListener('input', function() {
            updatePreview();
            if (currentEditorMode === 'simple') {
                setTimeout(parseTemplate, 500);
            }
        });
        document.getElementById('subject').addEventListener('input', updatePreview);
        
        document.getElementById('manualEmail').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addManualRecipient();
            }
        });
        
        document.getElementById('manualName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('manualEmail').focus();
            }
        });

        // === APP INITIALIZATION ===
        window.addEventListener('load', function() {
            const config = localStorage.getItem('emailConfig');
            
            if (!config || !JSON.parse(config).setupCompleted) {
                // Setup-Wizard anzeigen
                showSetupWizard();
            } else {
                // Direkt zur Hauptanwendung
                loadMainAppData();
            }
            
            // Initial setup
            loadTemplateList();
            updatePreview();
            setTimeout(parseTemplate, 100);
        });
    </script>
</body>
</html>